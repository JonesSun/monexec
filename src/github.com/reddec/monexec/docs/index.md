# MONEXEC

[![GitHub release](https://img.shields.io/github/release/reddec/monexec.svg)](https://github.com/reddec/monexec/releases)
[![license](https://img.shields.io/github/license/reddec/monexec.svg)](https://github.com/reddec/monexec)
[![](https://godoc.org/github.com/reddec/monexec/monexec?status.svg)](http://godoc.org/github.com/reddec/monexec/monexec)

It's tool for controlling processes like a **supervisord** but with some important features:
* Easy to use - no dependencies. Just a single binary file pre-compilled for most major platforms
* Easy to hack - monexec can be used as a Golang library with clean and simple architecture
* Integrated with Consul - optionally, monexec can register all running processes as services and deregister on fail
* Supports gracefull and fast shutdown by signals
* Developed for used inside Docker containers
* Different strategies for processes

[download for most major platform](https://github.com/reddec/monexec/releases)

# Installing

Precompilled binaries:
[release page](https://github.com/reddec/monexec/releases)

From source (required Go toolchain):

```
go get -v -u github.com/reddec/monexec/...
```

# How to integrate with Consul

Consul is a service registry and service discover system. MONEXEC can automatically register application in Consul as a service.

Auto(de)registration available for `run` or `start` commands.

Use general flag `--consul` (or env var `MONEXEC_CONSUL=true`) for enable Consul integration. Monexec will try register and update status of service in Consul local agent.

Monexec will continue work even if Consul becomes unavailable.

Consul address by default located to localhost, but can be overrided by `--consul-address` or `MONEXEC_CONSUL_ADDRESS` environment variable.

Additional Consul configuration is available only by [Go Consul API environment variables](https://godoc.org/github.com/hashicorp/consul/api#pkg-constants) (improvments for this are in roadmap).

## Examples:

**Register in local agent:**

Temporary (will auto de-registrate service in a critical state or after gracefull shutdown)

```bash
monexec run -l srv1 --consul -- nc -l 9000
```
Permanent

```bash
monexec run -l srv1 --consul --consul-permanent -- nc -l 9000
```

**Register in remote agent:**

Suppose Consul agent is running in host `registry`

```bash
monexec run --consul --consul-address "http://registry:8500" -l srv1 -- nc -l 9000
```

# How to integrate with Telegram

Since `0.1.1` you can receive notifications over Telegram.

You have to know:

* BOT token : can be obtained here http://t.me/botfather
* Receipients ChatID's : can be obtained here http://t.me/MyTelegramID_bot

Message template (based on Golang templates) also required. We recommend use this:

```
*{{.label}}*
Service {{.label}} {{.action}}
{{if .error}}⚠️ *Error:*  {{.error}}{{end}}
_time: {{.time}}_
_host: {{.hostname}}_
```

Available params:

* `.label` - name of service
* `.action` - servce action. Can be `spawned` or `stopped`
* `.time` - current time in UTC format with timezone
* `.error` - error message available only on `stopped` action
* `.hostname` - current hostname

Configuration avaiable only from .yaml files:

```yaml
telegram:
  # BOT token
  token: "123456789:AAAAAAAAAAAAAAAAAAAAAA_BBBBBBBBBBBB"
  services:
      # services that will be monitored
      - "listener2"
  recipients:
      # List of telegrams chat id
      - 123456789
  template: |
    *{{.label}}*
    Service {{.label}} {{.action}}
    {{if .error}}⚠️ *Error:*  {{.error}}{{end}}
    _time: {{.time}}_
    _host: {{.hostname}}_
```

# Usage

`monexec <command> [command-flags...] [args,...]`

All flags can be set by environment variables with prefix `MONEXEC_`. For example flag `--label sample` can be set as `export MONEXEC_LABEL="sample"`

## Commands

### run
Run single executable

**Usage:**
`monexec run [flags...] <executable> [args...]`

**Example:**
`monexec run -- nc -l 9000` - will run command `nc -l 9000` and restart it forever if needed with default timeout

**Flags:**

*  `--generate`             Generate to stdout YAML configuration based on args  instead of run
* `-r, --restart-count=-1`     Restart count (negative means infinity)
* `-d, --restart-delay=5s`     Delay before restart
* `-g, --graceful-timeout=5s`  Timeout for graceful shutdown. Application first got signal `SIGTERM` and after this timeout `SIGKILL`
* `-l, --label=LABEL`   Label name for executable. Default - autogenerated
* `-w, --workdir=WORKDIR`      Workdir for executable
* `-e, --env=ENV ...`          Environment addition variables
* `--consul`               Enable consul integration
* `--consul-address="http://localhost:8500"`  Consul address
* `--consul-permanent`    Keep service in consul auto timeout
* `--consul-ttl=3s`   Keep-alive TTL for services
* `--consul-unreg=1m`     Timeout after for auto de-registration

## start
Start processes based on YAML configuration files

**Usage:**
`monexec start <config file or dir,...>`

**Example:**

`monexec start ./*.yaml`

Configuration sources can be multiple directories and/or files. Files must contain valid YAML content and have `.yaml` or `.yml` extension.

Minimal configuration file:

```yaml
command: path/to/executable
```

Full sample of configuration file:

```yaml
services:
- label: Netcat Sample Service
  command: nc
  args:
  - -l
  - "9000"
  stop_timeout: 5s
  restart_delay: 5s
  restart: -1
consul:
  url: http://localhost:8500
  ttl: 3s
  timeout: 1m0s
```


# How to generate sample config

Generate configuration file based on `run` like arguments: just add `--generate`

**Usage:**

Same as `run`

For example, during development we are using

```bash
monexec run -l srvExt1 --consul --restart-count 10 restart -- java -jar srvExt1.jar
```

We want to save this settings into configuration file. Just add `--generate`

```bash
monexec run --generate -l srvExt1  --consul --restart-count 10 restart -- java -jar srvExt1.jar
```

and get

```yaml
services:
- label: srvExt1
  command: restart
  args:
  - java
  - -jar
  - srvExt1.jar
  stop_timeout: 5s
  restart_delay: 5s
  restart: 10
consul:
  url: http://localhost:8500
  ttl: 3s
  timeout: 1m0s
  register:
  - srvExt1
```

# Critical services


When critical services stopped, all other processes have to be stopped also


Add section `critical` to configuration:


```yaml
services:
- label: srvExt1
  command: restart
  args:
  - java
  - -jar
  - srvExt1.jar
  stop_timeout: 5s
  restart_delay: 5s
  restart: 10

- label: consul
  command: restart
  args:
  - consul
  - agen
  - -dev
  - -bootstrap
  - -ui
consul:
  url: http://localhost:8500
  ttl: 3s
  timeout: 1m0s
  register:
  - srvExt1
critical:
  - consul

```
